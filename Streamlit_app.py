import streamlit as st
import pandas as pd 
import joblib
import numpy as np 

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã 
st.set_page_config(
    page_title = "–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å —Ü–µ–Ω –Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å",
    page_icon= "üè†", 
    layout = 'wide'
)


# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ 
@st.cache_resource
def load_model():
    try:
        model = joblib.load('final_real_estate_pipeline.pkl')
        return model 
    except Exception as e:
        st.error(f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ :{e}')
        return None
    
# –û—Å–Ω–æ–≤–Ω–æ–π –∑–æ–≥–æ–ª–æ–≤–æ–∫
st.title('–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å —Ü–µ–Ω –Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å')
st.markdown('---')

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å 
model = load_model()

if model is not None:
    st.success("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ !")
    col1, col2 = st.columns(2)

    with col1:
        st.subheader('–û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏')
        total_area = st.number_input(
            '–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å(–º2)',
            min_value= 10.0,
            max_value= 500.0,
            value=65.0,
            step=0.5
        )

        numbere_of_rooms = st.selectbox(
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç",
            options=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        )
        
        ceiling_height = st.number_input(
            "–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤ (–º)",
            min_value=2.0,
            max_value=5.0,
            value=2.7,
            step=0.1
        )
        
        Time_metro = st.slider(
            "–í—Ä–µ–º—è –¥–æ –º–µ—Ç—Ä–æ (–º–∏–Ω)",
            min_value=1,
            max_value=60,
            value=15
        )
        
        property_type = st.selectbox(
            "–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
            options=['–ö–≤–∞—Ä—Ç–∏—Ä–∞', '–°—Ç—É–¥–∏—è', '–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã', '–ü–µ–Ω—Ç—Ö–∞—É—Å']
        )
        
        metro = st.text_input(
            "–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ",
            value="–¶–µ–Ω—Ç—Ä"
        )
    
    with col2:
        st.subheader("üé® –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏")
        
        renovation = st.selectbox(
            "–†–µ–º–æ–Ω—Ç",
            options=['–±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞', '–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π', '–µ–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π']
        )

        balcony = st.selectbox(
            "–ë–∞–ª–∫–æ–Ω",
            options=['–Ω–µ—Ç', '1 –±–∞–ª–∫–æ–Ω', '2 –±–∞–ª–∫–æ–Ω–∞', '–ª–æ–¥–∂–∏—è', '2 –ª–æ–¥–∂–∏–∏']
        )
        
        windows = st.selectbox(
            "–û–∫–Ω–∞",
            options=['–≤–æ –¥–≤–æ—Ä', '–Ω–∞ —É–ª–∏—Ü—É', '–Ω–∞ —É–ª–∏—Ü—É –∏ –¥–≤–æ—Ä']
        )
        
        parking = st.selectbox(
            "–ü–∞—Ä–∫–æ–≤–∫–∞",
            options=['–Ω–µ—Ç', '–Ω–∞–∑–µ–º–Ω–∞—è', '–ø–æ–¥–∑–µ–º–Ω–∞—è', '–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è', '–Ω–∞ –∫—Ä—ã—à–µ']
        )
        
        bathroom = st.selectbox(
            "–°–∞–Ω—É–∑–µ–ª",
            options=['—Å–æ–≤–º–µ—â–µ–Ω–Ω—ã–π', '—Ä–∞–∑–¥–µ–ª—å–Ω—ã–π', '2 —Å–∞–Ω—É–∑–ª–∞']
        )
        children_pets = st.selectbox(
            "–ú–æ–∂–Ω–æ —Å –¥–µ—Ç—å–º–∏/–∂–∏–≤–æ—Ç–Ω—ã–º–∏",
            options=['–ú–æ–∂–Ω–æ —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏', '–ú–æ–∂–Ω–æ —Å –¥–µ—Ç—å–º–∏', '–ú–æ–∂–Ω–æ —Å –¥–µ—Ç—å–º–∏, –ú–æ–∂–Ω–æ —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏']
        )
        
        pass_elevators = st.selectbox(
            "–ü–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏—Ö –ª–∏—Ñ—Ç–æ–≤",
            options=[0, 1, 2, 3, 4, 5]
        )
        
        cargo_elevators = st.selectbox(
            "–ì—Ä—É–∑–æ–≤—ã—Ö –ª–∏—Ñ—Ç–æ–≤",
            options=[0, 1, 2, 3, 4]
        )
    
    # –ü–æ–ª–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤
    st.subheader("üõãÔ∏è –£–¥–æ–±—Å—Ç–≤–∞")
    amenities = st.text_area(
        "–£–¥–æ–±—Å—Ç–≤–∞ (–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)",
        value="–ú–µ–±–µ–ª—å –Ω–∞ –∫—É—Ö–Ω–µ, –í–∞–Ω–Ω–∞, –°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞, –ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä",
        help="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ–±–µ–ª—å, –ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫, –ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –º–∞—à–∏–Ω–∞"
    )

    # –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π 
    if st.button('üéØ –ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—É", type="primary'):
        features_dict = {
            'total_area': total_area,
            'numbere_of_rooms': numbere_of_rooms,
            'ceiling_height': ceiling_height,
            'Time_metro': Time_metro,
            'property_type': property_type,
            'metro': metro,
            'renovation': renovation,
            'amenities': amenities,
            'balcony': balcony,
            'windows': windows,
            'parking': parking,
            'bathroom': bathroom,
            'children_pets': children_pets,
            'pass_elevators': pass_elevators,
            'cargo_elevators': cargo_elevators,
            'address': '–Ω–µ —É–∫–∞–∑–∞–Ω'  # –ê–¥—Ä–µ—Å –æ–±—ã—á–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        }
        
        try:
            # –°–æ–∑–¥–∞–µ–º DataFrame –∏ –¥–µ–ª–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
            new_data = pd.DataFrame([features_dict])
            predicted_price = model.predict(new_data)[0]
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            st.markdown("---")
            st.success(f"## üè† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞: ${predicted_price:,.0f}")
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            col_result1, col_result2, col_result3 = st.columns(3)
            
            with col_result1:
                st.metric(
                    label="üìä –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω",
                    value=f"${predicted_price * 0.9:,.0f} - ${predicted_price * 1.1:,.0f}",
                    help="–í–µ—Ä–æ—è—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω ¬±10%"
                )

            with col_result2:
                st.metric(
                    label="üéØ –¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏",
                    value="85.6%",
                    help="–°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
                )
            
            with col_result3:
                st.metric(
                    label="üìà –ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏",
                    value="R¬≤ = 0.790",
                    help="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏"
                )
            
            # –î–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
            with st.expander("üìã –î–µ—Ç–∞–ª–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"):
                st.json(features_dict)
                
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–∏: {e}")
    
    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    with st.sidebar:
        st.header("‚ÑπÔ∏è –û –º–æ–¥–µ–ª–∏")
        st.markdown("""
        **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –º–æ–¥–µ–ª–∏:**
        - –ê–ª–≥–æ—Ä–∏—Ç–º: Random Forest
        - –¢–æ—á–Ω–æ—Å—Ç—å (MAE): ¬±$7,412
        - –ö–∞—á–µ—Å—Ç–≤–æ (R¬≤): 0.790
        - –û–±—É—á–µ–Ω–∞ –Ω–∞: 20,000+ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        
        **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
        1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å —Ü–µ–Ω—É"
        3. –ü–æ–ª—É—á–∏—Ç–µ –æ—Ü–µ–Ω–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        
        **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –†–µ–∑—É–ª—å—Ç–∞—Ç —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–≥–Ω–æ–∑–æ–º –∏ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã.
        """)
        
        st.markdown("---")
        st.subheader("üöÄ –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–≥–Ω–æ–∑")
        
        # –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã
        template = st.selectbox(
            "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω:",
            ["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è", "–°—Ç—É–¥–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ", "–ü—Ä–µ–º–∏—É–º 3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è"]
        )
        
        if st.button("–ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω"):
            if template == "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è":
                st.session_state.update({
                    'total_area': 65.0,
                    'numbere_of_rooms': 2,
                    'ceiling_height': 2.7,
                    'Time_metro': 15,
                    'property_type': '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
                    'metro': '–°–ø—É—Ç–Ω–∏–∫',
                    'renovation': '–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π'
                })
            elif template == "–°—Ç—É–¥–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ":
                st.session_state.update({
                    'total_area': 40.0,
                    'numbere_of_rooms': 1,
                    'ceiling_height': 3.0,
                    'Time_metro': 5,
                    'property_type': '–°—Ç—É–¥–∏—è',
                    'metro': '–¶–µ–Ω—Ç—Ä',
                    'renovation': '–µ–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç'
                })
            elif template == "–ü—Ä–µ–º–∏—É–º 3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è":
                st.session_state.update({
                    'total_area': 95.0,
                    'numbere_of_rooms': 3,
                    'ceiling_height': 3.2,
                    'Time_metro': 10,
                    'property_type': '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
                    'metro': '–¶–µ–Ω—Ç—Ä',
                    'renovation': '–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π'
                })
            st.rerun()

else:
    st.error("""
    ‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:
    1. –§–∞–π–ª `final_real_estate_pipeline.pkl` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ
    2. –ú–æ–¥–µ–ª—å –±—ã–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    """)

# –§—É—Ç–µ—Ä
st.markdown("---")
st.markdown(
    "üìä *–ú–æ–¥–µ–ª—å –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ü–µ–Ω –Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å* ‚Ä¢ "
    "R¬≤ = 0.790 ‚Ä¢ MAE = $7,412"
)




